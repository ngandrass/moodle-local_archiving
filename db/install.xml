<?xml version="1.0" encoding="UTF-8" ?>
<XMLDB xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" COMMENT="XMLDB file for Moodle local/archiving" PATH="local/archiving/db" VERSION="2025091300" xsi:noNamespaceSchemaLocation="../../../lib/xmldb/xmldb.xsd">
  <TABLES>
    <TABLE NAME="local_archiving_job" COMMENT="Archive jobs">
      <FIELDS>
        <FIELD NAME="id" TYPE="int" LENGTH="10" NOTNULL="true" SEQUENCE="true"/>
        <FIELD NAME="contextid" TYPE="int" LENGTH="10" NOTNULL="true" SEQUENCE="false" COMMENT="ID of the context this job is run in"/>
        <FIELD NAME="userid" TYPE="int" LENGTH="10" NOTNULL="true" SEQUENCE="false" COMMENT="ID of the user that initiated this job"/>
        <FIELD NAME="origin" TYPE="text" NOTNULL="true" SEQUENCE="false" COMMENT="Archiving trigger plugin that was used to initiate this job"/>
        <FIELD NAME="status" TYPE="int" LENGTH="3" NOTNULL="true" SEQUENCE="false" COMMENT="Status of this job"/>
        <FIELD NAME="settings" TYPE="text" NOTNULL="false" SEQUENCE="false" COMMENT="Serialized JSON object with job settings"/>
        <FIELD NAME="timecreated" TYPE="int" LENGTH="10" NOTNULL="true" SEQUENCE="false" COMMENT="Time this job was created"/>
        <FIELD NAME="timemodified" TYPE="int" LENGTH="10" NOTNULL="true" SEQUENCE="false" COMMENT="Time this job was updated"/>
      </FIELDS>
      <KEYS>
        <KEY NAME="primary" TYPE="primary" FIELDS="id" />
        <KEY NAME="contextid" TYPE="foreign" FIELDS="contextid" REFTABLE="context" REFFIELDS="id"/>
        <KEY NAME="userid" TYPE="foreign" FIELDS="userid" REFTABLE="user" REFFIELDS="id"/>
      </KEYS>
    </TABLE>

    <TABLE NAME="local_archiving_metadata" COMMENT="Key-value store for persistent job metadata">
      <FIELDS>
        <FIELD NAME="id" TYPE="int" LENGTH="10" NOTNULL="true" SEQUENCE="true"/>
        <FIELD NAME="jobid" TYPE="int" LENGTH="10" NOTNULL="true" SEQUENCE="false" COMMENT="ID of the archiving job this entry is associated with"/>
        <FIELD NAME="datakey" TYPE="char" LENGTH="255" NOTNULL="true" SEQUENCE="false" COMMENT="Key of the entry"/>
        <FIELD NAME="datavalue" TYPE="text" NOTNULL="true" SEQUENCE="false" COMMENT="Value of the entry"/>
      </FIELDS>
      <KEYS>
        <KEY NAME="primary" TYPE="primary" FIELDS="id" />
        <KEY NAME="jobid" TYPE="foreign" FIELDS="jobid" REFTABLE="local_archiving_job" REFFIELDS="id"/>
      </KEYS>
      <INDEXES>
        <INDEX NAME="jobid_datakey" UNIQUE="false" FIELDS="jobid, datakey"/>
      </INDEXES>
    </TABLE>

    <TABLE NAME="local_archiving_activity_task" COMMENT="Generic information for activity archiving tasks">
      <FIELDS>
        <FIELD NAME="id" TYPE="int" LENGTH="10" NOTNULL="true" SEQUENCE="true"/>
        <FIELD NAME="jobid" TYPE="int" LENGTH="10" NOTNULL="true" SEQUENCE="false" COMMENT="ID of the archiving job this task is part of"/>
        <FIELD NAME="archivingmod" TYPE="text" NOTNULL="true" SEQUENCE="false" COMMENT="Name of the activity archiving driver used for this task"/>
        <FIELD NAME="contextid" TYPE="int" LENGTH="10" NOTNULL="true" SEQUENCE="false" COMMENT="ID of the context this task is run in"/>
        <FIELD NAME="fingerprint" TYPE="char" LENGTH="64" NOTNULL="true" SEQUENCE="false" COMMENT="CM state fingerprint at the point of task creation"/>
        <FIELD NAME="userid" TYPE="int" LENGTH="10" NOTNULL="true" SEQUENCE="false" COMMENT="ID of the user that initiated this task"/>
        <FIELD NAME="status" TYPE="int" LENGTH="3" NOTNULL="true" SEQUENCE="false" COMMENT="Status of this job"/>
        <FIELD NAME="progress" TYPE="int" LENGTH="3" NOTNULL="true" SEQUENCE="false" COMMENT="Task progress in percent (0-100)"/>
        <FIELD NAME="wstoken" TYPE="char" LENGTH="32" NOTNULL="false" SEQUENCE="false" COMMENT="Webservice token that is associated with this task"/>
        <FIELD NAME="settings" TYPE="text" NOTNULL="false" SEQUENCE="false" COMMENT="Serialized JSON object with optional task settings"/>
        <FIELD NAME="timecreated" TYPE="int" LENGTH="10" NOTNULL="true" SEQUENCE="false" COMMENT="Time this job was created"/>
        <FIELD NAME="timemodified" TYPE="int" LENGTH="10" NOTNULL="true" SEQUENCE="false" COMMENT="Time this job was updated"/>
      </FIELDS>
      <KEYS>
        <KEY NAME="primary" TYPE="primary" FIELDS="id"/>
        <KEY NAME="jobid" TYPE="foreign" FIELDS="jobid" REFTABLE="local_archiving_job" REFFIELDS="id"/>
        <KEY NAME="contextid" TYPE="foreign" FIELDS="contextid" REFTABLE="context" REFFIELDS="id"/>
        <KEY NAME="userid" TYPE="foreign" FIELDS="userid" REFTABLE="user" REFFIELDS="id"/>
      </KEYS>
      <INDEXES>
        <INDEX NAME="jobid" UNIQUE="false" FIELDS="jobid"/>
        <INDEX NAME="contextid" UNIQUE="false" FIELDS="contextid"/>
      </INDEXES>
    </TABLE>

    <TABLE NAME="local_archiving_tempfile" COMMENT="Assigns temporary Moodle files to archive jobs">
      <FIELDS>
        <FIELD NAME="id" TYPE="int" LENGTH="10" NOTNULL="true" SEQUENCE="true"/>
        <FIELD NAME="jobid" TYPE="int" LENGTH="10" NOTNULL="true" SEQUENCE="false" COMMENT="ID of the archiving job this file is associated with"/>
        <FIELD NAME="taskid" TYPE="int" LENGTH="10" NOTNULL="false" SEQUENCE="false" COMMENT="Optional ID of the activity archiving task this file is associated with"/>
        <FIELD NAME="fileid" TYPE="int" LENGTH="10" NOTNULL="true" SEQUENCE="false" COMMENT="ID of the file in the Moodle filestore"/>
        <FIELD NAME="sha256sum" TYPE="char" LENGTH="64" NOTNULL="false" SEQUENCE="false" COMMENT="SHA256 hash of the file"/>
      </FIELDS>
      <KEYS>
        <KEY NAME="primary" TYPE="primary" FIELDS="id"/>
        <KEY NAME="jobid" TYPE="foreign" FIELDS="jobid" REFTABLE="local_archiving_job" REFFIELDS="id"/>
        <KEY NAME="taskid" TYPE="foreign" FIELDS="taskid" REFTABLE="local_archiving_activity_task" REFFIELDS="id"/>
        <KEY NAME="fileid" TYPE="foreign" FIELDS="fileid" REFTABLE="files" REFFIELDS="id"/>
      </KEYS>
      <INDEXES>
        <INDEX NAME="jobid_taskid" UNIQUE="false" FIELDS="jobid, taskid"/>
        <INDEX NAME="fileid" UNIQUE="false" FIELDS="fileid"/>
      </INDEXES>
    </TABLE>

    <TABLE NAME="local_archiving_file" COMMENT="Holds persistent file handles for archive jobs">
      <FIELDS>
        <FIELD NAME="id" TYPE="int" LENGTH="10" NOTNULL="true" SEQUENCE="true"/>
        <FIELD NAME="jobid" TYPE="int" LENGTH="10" NOTNULL="true" SEQUENCE="false" COMMENT="ID of the archiving job this file handle is associated with"/>
        <FIELD NAME="archivingstore" TYPE="text" NOTNULL="true" SEQUENCE="false" COMMENT="Name of the archiving driver responsible for this file"/>
        <FIELD NAME="deleted" TYPE="int" LENGTH="1" NOTNULL="true" SEQUENCE="false" COMMENT="Whether this file has been deleted from storage"/>
        <FIELD NAME="filename" TYPE="text" NOTNULL="true" SEQUENCE="false" COMMENT="Name of the file"/>
        <FIELD NAME="filepath" TYPE="text" NOTNULL="false" SEQUENCE="false" COMMENT="Path of the file inside the storage (if applicable)"/>
        <FIELD NAME="filekey" TYPE="text" NOTNULL="false" SEQUENCE="false" COMMENT="Unique key identifying the file inside the storage (if applicable)"/>
        <FIELD NAME="filesize" TYPE="int" LENGTH="10" NOTNULL="true" SEQUENCE="false" COMMENT="Size of the file in bytes"/>
        <FIELD NAME="sha256sum" TYPE="char" LENGTH="64" NOTNULL="false" SEQUENCE="false" COMMENT="SHA256 hash of the file"/>
        <FIELD NAME="mimetype" TYPE="text" NOTNULL="false" SEQUENCE="false" COMMENT="MIME type of the file"/>
        <FIELD NAME="timecreated" TYPE="int" LENGTH="10" NOTNULL="true" SEQUENCE="false" COMMENT="Time this file handle was created"/>
        <FIELD NAME="timemodified" TYPE="int" LENGTH="10" NOTNULL="true" SEQUENCE="false" COMMENT="Time this file handle was updated"/>
      </FIELDS>
      <KEYS>
        <KEY NAME="primary" TYPE="primary" FIELDS="id"/>
        <KEY NAME="jobid" TYPE="foreign" FIELDS="jobid" REFTABLE="local_archiving_job" REFFIELDS="id"/>
      </KEYS>
      <INDEXES>
        <INDEX NAME="jobid" UNIQUE="false" FIELDS="jobid"/>
      </INDEXES>
    </TABLE>

    <TABLE NAME="local_archiving_tsp" COMMENT="RFC 3161 Time-Stamp Protocol data for archived files">
      <FIELDS>
        <FIELD NAME="id" TYPE="int" LENGTH="10" NOTNULL="true" SEQUENCE="true"/>
        <FIELD NAME="filehandleid" TYPE="int" LENGTH="10" NOTNULL="true" SEQUENCE="false" COMMENT="ID of the file handle this TSP data is for"/>
        <FIELD NAME="timecreated" TYPE="int" LENGTH="10" NOTNULL="true" SEQUENCE="false" COMMENT="Time this TSP data was stored"/>
        <FIELD NAME="server" TYPE="text" NOTNULL="true" SEQUENCE="false" COMMENT="URL of the RFC 3161 TSP server used for this request"/>
        <FIELD NAME="timestampquery" TYPE="binary" NOTNULL="true" SEQUENCE="false" COMMENT="DER encoded binary TSP query"/>
        <FIELD NAME="timestampreply" TYPE="binary" NOTNULL="true" SEQUENCE="false" COMMENT="DER encoded binary TSP reply"/>
      </FIELDS>
      <KEYS>
        <KEY NAME="primary" TYPE="primary" FIELDS="id"/>
        <KEY NAME="filehandleid" TYPE="foreign" FIELDS="filehandleid" REFTABLE="local_archiving_file" REFFIELDS="id"/>
      </KEYS>
      <INDEXES>
        <INDEX NAME="filehandleid" UNIQUE="false" FIELDS="filehandleid"/>
      </INDEXES>
    </TABLE>

    <TABLE NAME="local_archiving_log" COMMENT="Contians log entries for jobs, tasks, and other generic events">
      <FIELDS>
        <FIELD NAME="id" TYPE="int" LENGTH="10" NOTNULL="true" SEQUENCE="true"/>
        <FIELD NAME="level" TYPE="int" LENGTH="2" NOTNULL="true" SEQUENCE="false" COMMENT="Log level of this entry"/>
        <FIELD NAME="message" TYPE="text" NOTNULL="true" SEQUENCE="false" COMMENT="Log message"/>
        <FIELD NAME="jobid" TYPE="int" LENGTH="10" NOTNULL="false" SEQUENCE="false" COMMENT="ID of the archiving job this entry is associated with"/>
        <FIELD NAME="taskid" TYPE="int" LENGTH="10" NOTNULL="false" SEQUENCE="false" COMMENT="ID of the activity archiving task this entry is associated with"/>
        <FIELD NAME="timecreated" TYPE="int" LENGTH="10" NOTNULL="true" SEQUENCE="false" COMMENT="Time this entry was created"/>
      </FIELDS>
      <KEYS>
        <KEY NAME="primary" TYPE="primary" FIELDS="id"/>
        <KEY NAME="jobid" TYPE="foreign" FIELDS="jobid" REFTABLE="local_archiving_job" REFFIELDS="id"/>
        <KEY NAME="taskid" TYPE="foreign" FIELDS="taskid" REFTABLE="local_archiving_activity_task" REFFIELDS="id"/>
      </KEYS>
      <INDEXES>
        <INDEX NAME="jobid_taskid" UNIQUE="false" FIELDS="jobid, taskid"/>
      </INDEXES>
    </TABLE>

    <TABLE NAME="local_archiving_content" COMMENT="Holds metadata about data exported by activity archiving tasks">
      <FIELDS>
        <FIELD NAME="id" TYPE="int" LENGTH="10" NOTNULL="true" SEQUENCE="true"/>
        <FIELD NAME="taskid" TYPE="int" LENGTH="10" NOTNULL="true" SEQUENCE="false" COMMENT="ID of the activity archiving task this content was archived by"/>
        <FIELD NAME="userid" TYPE="int" LENGTH="10" NOTNULL="true" SEQUENCE="false" COMMENT="ID of the user that created the original data"/>
        <FIELD NAME="summary" TYPE="text" NOTNULL="false" SEQUENCE="false" COMMENT="Descriptive summary / label of the archived data"/>
        <FIELD NAME="reftable" TYPE="text" NOTNULL="false" SEQUENCE="false" COMMENT="Name of the table that stores the referenced original data"/>
        <FIELD NAME="refid" TYPE="int" LENGTH="10" NOTNULL="false" SEQUENCE="false" COMMENT="ID of the original data inside the reftable"/>
      </FIELDS>
      <KEYS>
        <KEY NAME="primary" TYPE="primary" FIELDS="id"/>
        <KEY NAME="taskid" TYPE="foreign" FIELDS="taskid" REFTABLE="local_archiving_activity_task" REFFIELDS="id"/>
        <KEY NAME="userid" TYPE="foreign" FIELDS="userid" REFTABLE="user" REFFIELDS="id"/>
      </KEYS>
      <INDEXES>
        <INDEX NAME="taskid" UNIQUE="false" FIELDS="taskid"/>
        <INDEX NAME="userid" UNIQUE="false" FIELDS="userid"/>
      </INDEXES>
    </TABLE>
  </TABLES>
</XMLDB>
