<?xml version="1.0" encoding="UTF-8" ?>
  <XMLDB PATH="local/archiving/db" VERSION="2025052200" COMMENT="XMLDB file for Moodle local/archiving">
    <TABLES>
      <TABLE NAME="local_archiving_job" COMMENT="Archive jobs">
        <FIELDS>
          <FIELD NAME="id" TYPE="int" LENGTH="10" NOTNULL="true" SEQUENCE="true"/>
          <FIELD NAME="contextid" TYPE="int" LENGTH="10" NOTNULL="true" SEQUENCE="false" COMMENT="ID of the context this job is run in"/>
          <FIELD NAME="userid" TYPE="int" LENGTH="10" NOTNULL="true" SEQUENCE="false" COMMENT="ID of the user that initiated this job"/>
          <FIELD NAME="status" TYPE="int" LENGTH="3" NOTNULL="true" SEQUENCE="false" COMMENT="Status of this job"/>
          <FIELD NAME="settings" TYPE="text" NOTNULL="false" SEQUENCE="false" COMMENT="Serialized JSON object with job settings"/>
          <FIELD NAME="timecreated" TYPE="int" LENGTH="10" NOTNULL="true" SEQUENCE="false" COMMENT="Time this job was created"/>
          <FIELD NAME="timemodified" TYPE="int" LENGTH="10" NOTNULL="true" SEQUENCE="false" COMMENT="Time this job was updated"/>
        </FIELDS>
        <KEYS>
          <KEY NAME="primary" TYPE="primary" FIELDS="id" />
          <KEY NAME="contextid" TYPE="foreign" FIELDS="contextid" REFTABLE="context" REFFIELDS="id"/>
          <KEY NAME="userid" TYPE="foreign" FIELDS="userid" REFTABLE="user" REFFIELDS="id"/>
        </KEYS>
      </TABLE>

      <TABLE NAME="local_archiving_metadata" COMMENT="Key-value store for persistent job metadata">
        <FIELDS>
          <FIELD NAME="id" TYPE="int" LENGTH="10" NOTNULL="true" SEQUENCE="true"/>
          <FIELD NAME="jobid" TYPE="int" LENGTH="10" NOTNULL="true" SEQUENCE="false" COMMENT="ID of the archiving job this entry is associated with"/>
          <FIELD NAME="datakey" TYPE="text" NOTNULL="true" SEQUENCE="false" COMMENT="Key of the entry"/>
          <FIELD NAME="datavalue" TYPE="text" NOTNULL="true" SEQUENCE="false" COMMENT="Value of the entry"/>
        </FIELDS>
        <KEYS>
          <KEY NAME="primary" TYPE="primary" FIELDS="id" />
          <KEY NAME="jobid" TYPE="foreign" FIELDS="jobid" REFTABLE="local_archiving_job" REFFIELDS="id"/>
        </KEYS>
      </TABLE>

      <TABLE NAME="local_archiving_activity_task" COMMENT="Generic information for activity archiving tasks">
        <FIELDS>
          <FIELD NAME="id" TYPE="int" LENGTH="10" NOTNULL="true" SEQUENCE="true"/>
          <FIELD NAME="jobid" TYPE="int" LENGTH="10" NOTNULL="true" SEQUENCE="false" COMMENT="ID of the archiving job this task is part of"/>
          <FIELD NAME="archivingmod" TYPE="text" NOTNULL="true" SEQUENCE="false" COMMENT="Name of the activity archiving driver used for this task"/>
          <FIELD NAME="contextid" TYPE="int" LENGTH="10" NOTNULL="true" SEQUENCE="false" COMMENT="ID of the context this task is run in"/>
          <FIELD NAME="userid" TYPE="int" LENGTH="10" NOTNULL="true" SEQUENCE="false" COMMENT="ID of the user that initiated this task"/>
          <FIELD NAME="status" TYPE="int" LENGTH="3" NOTNULL="true" SEQUENCE="false" COMMENT="Status of this job"/>
          <FIELD NAME="progress" TYPE="number" LENGTH="3" NOTNULL="true" SEQUENCE="false" COMMENT="Task progress in percent (0-100)"/>
          <FIELD NAME="wstoken" TYPE="char" LENGTH="32" NOTNULL="false" SEQUENCE="false" COMMENT="Webservice token that is associated with this task"/>
          <FIELD NAME="settings" TYPE="text" NOTNULL="false" SEQUENCE="false" COMMENT="Serialized JSON object with optional task settings"/>
          <FIELD NAME="timecreated" TYPE="int" LENGTH="10" NOTNULL="true" SEQUENCE="false" COMMENT="Time this job was created"/>
          <FIELD NAME="timemodified" TYPE="int" LENGTH="10" NOTNULL="true" SEQUENCE="false" COMMENT="Time this job was updated"/>
        </FIELDS>
        <KEYS>
          <KEY NAME="primary" TYPE="primary" FIELDS="id"/>
          <KEY NAME="jobid" TYPE="foreign" FIELDS="jobid" REFTABLE="local_archiving_job" REFFIELDS="id"/>
          <KEY NAME="contextid" TYPE="foreign" FIELDS="contextid" REFTABLE="context" REFFIELDS="id"/>
          <KEY NAME="userid" TYPE="foreign" FIELDS="userid" REFTABLE="user" REFFIELDS="id"/>
        </KEYS>
      </TABLE>

      <TABLE NAME="local_archiving_tempfile" COMMENT="Assigns temporary Moodle files to archive jobs">
        <FIELDS>
          <FIELD NAME="id" TYPE="int" LENGTH="10" NOTNULL="true" SEQUENCE="true"/>
          <FIELD NAME="jobid" TYPE="int" LENGTH="10" NOTNULL="true" SEQUENCE="false" COMMENT="ID of the archiving job this file is associated with"/>
          <FIELD NAME="taskid" TYPE="int" LENGTH="10" NOTNULL="false" SEQUENCE="false" COMMENT="Optional ID of the activity archiving task this file is associated with"/>
          <FIELD NAME="fileid" TYPE="int" LENGTH="10" NOTNULL="true" SEQUENCE="false" COMMENT="ID of the file in the Moodle filestore"/>
          <FIELD NAME="sha256sum" TYPE="char" LENGTH="64" NOTNULL="false" SEQUENCE="false" COMMENT="SHA256 hash of the file"/>
        </FIELDS>
        <KEYS>
          <KEY NAME="primary" TYPE="primary" FIELDS="id"/>
          <KEY NAME="jobid" TYPE="foreign" FIELDS="jobid" REFTABLE="local_archiving_job" REFFIELDS="id"/>
          <KEY NAME="taskid" TYPE="foreign" FIELDS="taskid" REFTABLE="local_archiving_activity_task" REFFIELDS="id"/>
          <KEY NAME="fileid" TYPE="foreign" FIELDS="fileid" REFTABLE="files" REFFIELDS="id"/>
        </KEYS>
      </TABLE>

      <TABLE NAME="local_archiving_file" COMMENT="Holds persistent file handles for archive jobs">
        <FIELDS>
          <FIELD NAME="id" TYPE="int" LENGTH="10" NOTNULL="true" SEQUENCE="true"/>
          <FIELD NAME="jobid" TYPE="int" LENGTH="10" NOTNULL="true" SEQUENCE="false" COMMENT="ID of the archiving job this file handle is associated with"/>
          <FIELD NAME="archivingstore" TYPE="text" NOTNULL="true" SEQUENCE="false" COMMENT="Name of the archiving driver responsible for this file"/>
          <FIELD NAME="filename" TYPE="text" NOTNULL="true" SEQUENCE="false" COMMENT="Name of the file"/>
          <FIELD NAME="filepath" TYPE="text" NOTNULL="false" SEQUENCE="false" COMMENT="Path of the file inside the storage (if applicable)"/>
          <FIELD NAME="filekey" TYPE="text" NOTNULL="false" SEQUENCE="false" COMMENT="Unique key identifying the file inside the storage (if applicable)"/>
          <FIELD NAME="filesize" TYPE="int" LENGTH="10" NOTNULL="true" SEQUENCE="false" COMMENT="Size of the file in bytes"/>
          <FIELD NAME="sha256sum" TYPE="char" LENGTH="64" NOTNULL="false" SEQUENCE="false" COMMENT="SHA256 hash of the file"/>
        </FIELDS>
        <KEYS>
          <KEY NAME="primary" TYPE="primary" FIELDS="id"/>
          <KEY NAME="jobid" TYPE="foreign" FIELDS="jobid" REFTABLE="local_archiving_job" REFFIELDS="id"/>
        </KEYS>
      </TABLE>

      <TABLE NAME="local_archiving_log" COMMENT="Contians log entries for jobs, tasks, and other generic events">
        <FIELDS>
          <FIELD NAME="id" TYPE="int" LENGTH="10" NOTNULL="true" SEQUENCE="true"/>
          <FIELD NAME="level" TYPE="int" LENGTH="2" NOTNULL="true" SEQUENCE="false" COMMENT="Log level of this entry"/>
          <FIELD NAME="message" TYPE="text" NOTNULL="true" SEQUENCE="false" COMMENT="Log message"/>
          <FIELD NAME="jobid" TYPE="int" LENGTH="10" NOTNULL="false" SEQUENCE="false" COMMENT="ID of the archiving job this entry is associated with"/>
          <FIELD NAME="taskid" TYPE="int" LENGTH="10" NOTNULL="false" SEQUENCE="false" COMMENT="ID of the activity archiving task this entry is associated with"/>
          <FIELD NAME="timecreated" TYPE="int" LENGTH="10" NOTNULL="true" SEQUENCE="false" COMMENT="Time this entry was created"/>
        </FIELDS>
        <KEYS>
          <KEY NAME="primary" TYPE="primary" FIELDS="id"/>
          <KEY NAME="jobid" TYPE="foreign" FIELDS="jobid" REFTABLE="local_archiving_job" REFFIELDS="id"/>
          <KEY NAME="taskid" TYPE="foreign" FIELDS="taskid" REFTABLE="local_archiving_activity_task" REFFIELDS="id"/>
        </KEYS>
      </TABLE>
    </TABLES>
  </XMLDB>
